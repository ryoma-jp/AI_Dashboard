{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load custom_filter %}

{% block main %}
<div class="container-fluid">
  <div class="row">
  
    <!-- Main -->
    
        <!-- Home tab -->
        <div id="home" class="tab-pane">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Home</h1>
          </div>

          <h1 class="h3">Projects and Models</h1>
          <a class="btn btn-primary" href="{% url 'project_new' %}">New Project</a>
          {% if projects %}
            {% for project in projects %}
              <p>
              <h1 class="h4">{{ project.name }}  <small><a href="{% url 'project_edit' project.id %}">Edit</a></small></h1>
              <p>{{ project.description | linebreaksbr }}</p>
              <a class="btn btn-primary" href="{% url 'model_new' project.id %}">New Model</a>
              {% if models|in_project:project %}
                <p><table class="table table-bordered border-primary table-hover ms-4">
                  <thead class="table-dark">
                    <tr>
                      <th scope="col">Name</th>
                      <th scope="col">Description</th>
                      <th scope="col">Dataset</th>
                      <th scope="col">Training Status</th>
                      <th scope="col">Metrics</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for model in models|in_project:project %}
                    <tr>
                      <td><a href="{% url 'model_edit' project.id model.id %}">{{ model.name }}</a></td>
                      <td>{{ model.description | linebreaksbr }}</td>
                      <td>{{ model.dataset }}</td>
                      <td>{{ model.status }}</td>
                      <td>
                        <ul>
                          {% with model|get_metrics as dict_metrics %}
                            {% for key, value in dict_metrics.items %}
                              <li>{{ key }} : {{ value }}</li>
                            {% endfor %}
                          {% endwith %}
                        </ul>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table></p>
              {% else %}
                <p>No Models</p>
              {% endif %}
              </p>
            {% endfor %}
          {% else %}
            <p>No Projects</p>
          {% endif %}
          
          <h1 class="h3">System Information</h1>
          <table class="table table-bordered border-primary table-hover ms-4">
            {% for info in system_info %}
              <tr>
                <td>{{ info.name }}</td>
                <td>
                  <ul>
                    <li>[device_type] {{ info.device_type }}</li>
                    {% if info.physical_device_desc %}
                      <li>[physical_device_desc] {{ info.physical_device_desc }}</li>
                    {% else %}
                      <li>[physical_device_desc] (no description)</li>
                    {% endif %}
                  </ul>
                </td>
              </tr>
            {% endfor %}
          </table>

          <h1 class="h3">Recent Jobs</h1>
          <div class="card my-3" id="recent-jobs">
            <div class="card-body recent-jobs-scroll">
              {% if recent_jobs %}
                {% for job in recent_jobs %}
                  {% with is_first=forloop.first %}
                    <div class="card my-2 progress-job-card" data-job-id="{{ job.id }}">
                      <div class="card-header d-flex justify-content-between align-items-center collapse-toggle" data-bs-toggle="collapse" data-bs-target="#job-steps-{{ job.id }}" aria-expanded="{{ is_first|yesno:'true,false' }}" aria-controls="job-steps-{{ job.id }}">
                        <div class="d-flex align-items-center gap-2">
                          <span class="collapse-icon" aria-hidden="true">{% if is_first %}▼{% else %}▶{% endif %}</span>
                          <div>
                            <span class="fw-bold">{{ job.job_type }}</span>
                            <span class="text-muted">#{{ job.id }}</span>
                          </div>
                        </div>
                        <span class="text-muted small job-status">{{ job.status }}</span>
                      </div>
                      <div id="job-steps-{{ job.id }}" class="collapse {% if is_first %}show{% endif %}">
                        <ul class="list-group list-group-flush job-steps">
                          <li class="list-group-item text-muted">Loading...</li>
                        </ul>
                      </div>
                    </div>
                  {% endwith %}
                {% endfor %}
              {% else %}
                <p class="text-muted">No jobs.</p>
              {% endif %}
            </div>
          </div>
        </div>
        
  </div>
</div>

<script>
(function() {
  const cards = Array.from(document.querySelectorAll('.progress-job-card'));
  if (!cards.length) { return; }

  // wire collapse icons to reflect open/close state
  const wireCollapse = (card) => {
    const collapseEl = card.querySelector('.collapse');
    const iconEl = card.querySelector('.collapse-icon');
    if (!collapseEl || !iconEl) { return; }

    const setIcon = (expanded) => {
      iconEl.textContent = expanded ? '▼' : '▶';
    };

    setIcon(collapseEl.classList.contains('show'));
    collapseEl.addEventListener('show.bs.collapse', () => setIcon(true));
    collapseEl.addEventListener('hide.bs.collapse', () => setIcon(false));
  };

  cards.forEach(wireCollapse);

  const badgeHtml = (status) => {
    const tone = {
      'PENDING': 'secondary',
      'RUNNING': 'info',
      'DONE': 'success',
      'ERROR': 'danger',
      'CANCELED': 'warning',
    }[status] || 'secondary';
    return '<span class="badge bg-' + tone + '">' + status + '</span>';
  };

  const renderJob = (card, job) => {
    const statusEl = card.querySelector('.job-status');
    const listEl = card.querySelector('.job-steps');
    if (statusEl) {
      statusEl.innerHTML = badgeHtml(job.status);
    }
    if (!listEl) { return; }

    listEl.innerHTML = '';
    const steps = (job.steps || []).slice().sort((a, b) => a.order - b.order);
    if (!steps.length) {
      listEl.innerHTML = '<li class="list-group-item text-muted">No steps.</li>';
      return;
    }

    steps.forEach((step) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex align-items-center gap-2';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.disabled = true;
      checkbox.className = 'form-check-input';
      checkbox.checked = step.status === 'DONE';
      li.appendChild(checkbox);

      const label = document.createElement('span');
      label.className = 'flex-grow-1';
      label.textContent = step.label;
      li.appendChild(label);

      if (step.status === 'RUNNING') {
        const spinner = document.createElement('div');
        spinner.className = 'spinner-border spinner-border-sm text-primary';
        spinner.setAttribute('role', 'status');
        spinner.innerHTML = '<span class="visually-hidden">Loading...</span>';
        li.appendChild(spinner);
      }

      const state = document.createElement('span');
      state.innerHTML = badgeHtml(step.status);
      li.appendChild(state);

      listEl.appendChild(li);

      if (step.detail) {
        const detailLi = document.createElement('li');
        detailLi.className = 'list-group-item small text-muted';
        detailLi.textContent = step.detail;
        listEl.appendChild(detailLi);
      }
    });
  };

  const fetchJob = async (card) => {
    const jobId = card.dataset.jobId;
    if (!jobId) { return; }
    const res = await fetch('/api/jobs/' + jobId + '/');
    if (!res.ok) {
      throw new Error('Failed to fetch job ' + jobId);
    }
    const data = await res.json();
    renderJob(card, data);
    return data;
  };

  let timerId = null;
  const tick = async () => {
    try {
      const results = await Promise.all(cards.map((c) => fetchJob(c)));
      const anyRunning = results.some((j) => j && !['DONE', 'ERROR', 'CANCELED'].includes(j.status));
      if (!anyRunning && timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
    } catch (e) {
      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
      console.error(e);
    }
  };

  tick();
  timerId = setInterval(tick, 1000);
})();
</script>
{% endblock %}


{% extends "base.html" %}
{% load django_bootstrap5 %}

{% block main %}
<div class="container-fluid">
  <h2> New Model</h2>
  {% if error_message %}
    <div class="alert alert-warning" role="alert">{{ error_message }}</div>
  {% endif %}
  <form method="post" id="model-new-form">
    {% csrf_token %}
    {% bootstrap_form form %}
    
    <div class="dropdown my-3">
      <button type="button" class="btn btn-primary dropdown-toggle" id="model_new_model_dropdown" data-bs-toggle="dropdown" aria-expanded="false">
        {% if model_new_model_selected %}
          {{ model_new_model_selected.name }}
        {% else %}
          Select Model
        {% endif %}
      </button>
      <ul class="dropdown-menu" area-labelledby="model_new_model_dropdown" id="model_new_model_dropdown_list">
      {% for model_ in model %}
        <li><button type="button" class="dropdown-item" value="{{ model_.name }}">{{ model_.name }}</button></li>
      {% endfor %}
      </ul>
        <script>
          // id=model_new_model_dropdown_listのdropdown-menu内のliタグに対してリスナにクリックイベントを追加する
          dropdown_list = document.querySelector('#model_new_model_dropdown_list')
          dropdown_list.querySelectorAll('li').forEach( function(el) {
            el.addEventListener('click', function() {
              // console.log('Click dropdown item');
              // console.log(el.textContent);
              
              display = document.getElementById('model_new_model_dropdown');
              display.innerText = el.textContent;
              
              ele = document.getElementById('model_new_model_dropdown_submit')
              ele.value = el.textContent;
            });
          });
        </script>
        <input type="hidden" name="model_new_model_dropdown_submit" id="model_new_model_dropdown_submit" value="">
    </div>
    
    <div class="dropdown my-3">
      <button type="button" class="btn btn-primary dropdown-toggle" id="model_new_dataset_dropdown" data-bs-toggle="dropdown" aria-expanded="false">
        {% if model_new_dataset_selected %}
          {{ model_new_dataset_selected.name }}
        {% else %}
          Select Dataset
        {% endif %}
      </button>
      <ul class="dropdown-menu" area-labelledby="model_new_dataset_dropdown" id="model_new_dataset_dropdown_list">
      {% for dataset_ in dataset %}
        <li><button type="button" class="dropdown-item" value="{{ dataset_.name }}">{{ dataset_.name }}</button></li>
      {% endfor %}
      </ul>
        <script>
          // id=model_new_dataset_dropdown_listのdropdown-menu内のliタグに対してリスナにクリックイベントを追加する
          dropdown_list = document.querySelector('#model_new_dataset_dropdown_list')
          dropdown_list.querySelectorAll('li').forEach( function(el) {
            el.addEventListener('click', function() {
              // console.log('Click dropdown item');
              // console.log(el.textContent);
              
              display = document.getElementById('model_new_dataset_dropdown');
              display.innerText = el.textContent;
              
              ele = document.getElementById('model_new_dataset_dropdown_submit')
              ele.value = el.textContent;
            });
          });
        </script>
        <input type="hidden" name="model_new_dataset_dropdown_submit" id="model_new_dataset_dropdown_submit" value="">
    </div>
    
    {% bootstrap_button button_type="submit" content="Add Model" %}
    <a class="btn btn-primary" href="{% url 'index' %}" role="button">Cancel</a>
  </form>

  <div class="card my-4 progress-checklist" id="model-create-progress" data-job-id="{{ job_id|default:'' }}">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">Progress</span>
      <span class="text-muted small" id="model-create-status"></span>
    </div>
    <ul class="list-group list-group-flush" id="model-create-steps">
      <li class="list-group-item text-muted">No job.</li>
    </ul>
  </div>
</div>

<script>
(function() {
  const card = document.getElementById('model-create-progress');
  const form = document.getElementById('model-new-form');
  if (!card || !form) { return; }

  const listEl = document.getElementById('model-create-steps');
  const statusEl = document.getElementById('model-create-status');

  const stepsPreset = [
    'Validate inputs',
    'Create model record + hash',
    'Create model/env directories',
    'Prepare dataset (download/verify/build dataset.pkl)',
    'Write config.json + FIFOs',
    'Save model metadata',
    'Done',
  ];

  const badge = (status) => {
    const tone = {
      'PENDING': 'secondary',
      'RUNNING': 'info',
      'DONE': 'success',
      'ERROR': 'danger',
      'CANCELED': 'warning',
    }[status] || 'secondary';
    return '<span class="badge bg-' + tone + '">' + status + '</span>';
  };

  const renderLocalPreset = () => {
    statusEl.textContent = 'Starting...';
    listEl.innerHTML = '';
    stepsPreset.forEach((label) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex align-items-center gap-2';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.disabled = true;
      cb.className = 'form-check-input';
      li.appendChild(cb);
      const span = document.createElement('span');
      span.className = 'flex-grow-1';
      span.textContent = label;
      li.appendChild(span);
      listEl.appendChild(li);
    });
  };

  const render = (job) => {
    statusEl.innerHTML = badge(job.status);
    listEl.innerHTML = '';
    (job.steps || []).slice().sort((a,b)=>a.order-b.order).forEach((s) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex align-items-center gap-2';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.disabled = true;
      cb.className = 'form-check-input';
      cb.checked = s.status === 'DONE';
      li.appendChild(cb);
      const label = document.createElement('span');
      label.className = 'flex-grow-1';
      label.textContent = s.label;
      li.appendChild(label);
      if (s.status === 'RUNNING') {
        const sp = document.createElement('div');
        sp.className = 'spinner-border spinner-border-sm text-primary';
        sp.setAttribute('role','status');
        sp.innerHTML = '<span class="visually-hidden">Loading...</span>';
        li.appendChild(sp);
      }
      const st = document.createElement('span');
      st.innerHTML = badge(s.status);
      li.appendChild(st);
      listEl.appendChild(li);
      if (s.detail) {
        const d = document.createElement('li');
        d.className = 'list-group-item small text-muted';
        d.textContent = s.detail;
        listEl.appendChild(d);
      }
    });
  };

  let timer = null;
  const stopTimer = () => { if (timer) { clearInterval(timer); timer = null; } };

  const startPolling = (jobId) => {
    const tick = async () => {
      const res = await fetch('/api/jobs/' + jobId + '/');
      if (!res.ok) { throw new Error('Failed to fetch job'); }
      const data = await res.json();
      render(data);
      if (['DONE','ERROR','CANCELED'].includes(data.status)) {
        stopTimer();
        if (data.status === 'DONE') {
          setTimeout(() => { window.location.href = '/'; }, 300);
        }
      }
    };
    tick().catch(console.error);
    timer = setInterval(() => tick().catch(console.error), 1000);
  };

  const getCsrf = () => {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  };

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    renderLocalPreset();
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) { submitBtn.disabled = true; }
    const fd = new FormData(form);
    fetch(form.getAttribute('action') || window.location.pathname, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrf(),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: fd,
    }).then(async (res) => {
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Request failed');
      }
      const data = await res.json();
      if (data.job_id) {
        card.dataset.jobId = data.job_id;
        startPolling(data.job_id);
      }
    }).catch((err) => {
      console.error(err);
      statusEl.textContent = 'Error';
    }).finally(() => {
      if (submitBtn) { submitBtn.disabled = false; }
    });
  });

  // If job id already exists (e.g., redirected with ?job=...), start polling.
  if (card.dataset.jobId) {
    startPolling(card.dataset.jobId);
  }
})();
</script>
{% endblock %}


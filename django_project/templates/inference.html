{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load custom_filter %}

{% block main %}
<div class="container-fluid">
  <div class="row">
  
    <!-- Inference tab -->
    <div id="inference" class="tab-pane">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Inference</h1>
      </div>
      
      <h1 class="h3">Select Project</h1>
      {% if project %}
        <form method="post">
          {% csrf_token %}
            <div class="btn-group">
              <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                {% if project_dropdown_selected %}
                  {{ project_dropdown_selected.name }}
                {% else %}
                  Select Project
                {% endif %}
              </button>
              <ul class="dropdown-menu">
              {% for project_ in project %}
                <li><button class="dropdown-item" type="submit" name="inference_view_project_dropdown" value="{{ project_.name }}">{{ project_.name }}</button></li>
              {% endfor %}
              </ul>
            </div>
        </form>
        
        <h1 class="h3">Select Model</h1>
        {% if model|in_project:project_dropdown_selected %}
          <form method="post">
            {% csrf_token %}
              <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  {% if model_dropdown_selected %}
                    {{ model_dropdown_selected.name }}
                  {% else %}
                    Select Model
                  {% endif %}
                </button>
                <ul class="dropdown-menu">
                {% for model_ in model %}
                  <li><button class="dropdown-item" type="submit" name="inference_view_model_dropdown" value="{{ model_.name }}">{{ model_.name }}</button></li>
                {% endfor %}
                </ul>
              </div>
          </form>
          
          {% if model_dropdown_selected %}
            {% if model_dropdown_selected.status|stringformat:'s' != 'DONE' %}
              <p><font color="red">!! Please select the trained model !!</font></p>
            {% endif %}
            <p><table class="table table-bordered border-primary table-hover ms-4">
              <tr>
                <td>Name</td>
                <td>{{ model_dropdown_selected.name }}</td>
              </tr>
              <tr>
                <td>Description</td>
                <td>{{ model_dropdown_selected.description | linebreaksbr }}</td>
              </tr>
              <tr>
                <td>Project</td>
                <td>{{ model_dropdown_selected.project.name }}</td>
              </tr>
              <tr>
                <td>Status</td>
                <td>{{ model_dropdown_selected.status }}</td>
              </tr>
              <tr>
                <td>Training PID(debug)</td>
                {% if model_dropdown_selected.training_pid %}
                  <td>{{ model_dropdown_selected.training_pid }}</td>
                {% else %}
                  <td>--- (Not Training)</td>
                {% endif %}
              </tr>
              <tr>
                <td>Tensorboard PID(debug)</td>
                {% if model_dropdown_selected.tensorboard_pid %}
                  <td>{{ model_dropdown_selected.tensorboard_pid }}</td>
                {% else %}
                  <td>--- (Not Training)</td>
                {% endif %}
              </tr>
              <tr>
                <td>Model hash(debug)</td>
                <td>{{ model_dropdown_selected.hash }}</td>
              </tr>
            </table></p>
          {% else %}
            <p>Unknown Model</p>
          {% endif %}
        {% else %}
          <p>No Model registered</p>
        {% endif %}
        
        <h1 class="h3">Select Dataset</h1>
        <p>
        (T.B.D) <br>
        dataset dropdown will be selected dataset that user required to inference. <br>
        NOW inference dataset is related in selected model.
        </p>
        <form method="post">
        {% csrf_token %}
          <div class="btn-group">
            <!-- select dataset -->
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            {% if dataset_dropdown_selected %}
              {{ dataset_dropdown_selected.name }}
            {% else %}
              Select Dataset
            {% endif %}
            </button>
            <ul class="dropdown-menu">
            {% for dataset_ in dataset %}
              <li><button class="dropdown-item" type="submit" name="inference_view_dataset_dropdown" value="{{ dataset_.name }}">{{ dataset_.name }}</button></li>
            {% endfor %}
            </ul>
          </div>
        </form>
      
        <h1 class="h3">Prediction</h1>
        <form method="post" id="inference-run-form">
        {% csrf_token %}
          {% if model_dropdown_selected and model_dropdown_selected.status|stringformat:'s' == 'DONE' and dataset_dropdown_selected %}
            <button type="submit" class="btn btn-primary" id="inference_run" name="inference_run" value="inference_run">Run</button>
          {% else %}
            <button type="submit" class="btn btn-primary" id="inference_run" name="inference_run" value="inference_run" disabled>Run</button>
          {% endif %}
        </form>

        <h1 class="h4">Progress</h1>
        <div class="card my-3" id="inference-progress" data-job-id="{{ job_id|default_if_none:'' }}">
          <div class="card-body" id="inference-progress-body">
            {% if job_id %}
              <p class="text-muted">Loading job {{ job_id }}...</p>
            {% else %}
              <p class="text-muted">No inference job running.</p>
            {% endif %}
          </div>
        </div>
        
        <h1 class="h4">Result</h1>
        
        {% if prediction %}
          <ul>
            {% with model_dropdown_selected|get_metrics as dict_metrics %}
              {% for key, value in dict_metrics.items %}
                <li>{{ key }} : {{ value }}</li>
              {% endfor %}
            {% endwith %}
          </ul>
          {% if dataloader_obj.dataset_type|stringformat:'s' == 'img_clf' or dataloader_obj.dataset_type|stringformat:'s' == 'table_clf' %}
            <p><a href="{% url 'download_prediction' %}">Download prediction as csv</a></p>
          {% endif %}
          
          <div class="container">
            <div class="row">
              <div class="col-1">
                <h1 class="h5">Type: </h1>
              </div>
              <div class="col-1">
                <form method="post">
                {% csrf_token %}
                  <div class="btn-group">
                    <!-- select dataset type -->
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                      {{ prediction_data_type_selected }}
                    </button>
                    <ul class="dropdown-menu">
                      <li><button class="dropdown-item" type="submit" name="prediction_data_type" value="Train">Train</button></li>
                      <li><button class="dropdown-item" type="submit" name="prediction_data_type" value="Validation">Validation</button></li>
                      <li><button class="dropdown-item" type="submit" name="prediction_data_type" value="Test">Test</button></li>
                    </ul>
                  </div>
                </form>
              </div>
            </div>
          </div>
        
        
          {% if dataloader_obj.dataset_type|stringformat:'s' == 'img_det' %}
            <p><table class="table table-bordered border-primary table-hover ms-4">
              <thead class="table-dark">
                <tr>
                  <th scope="col">データID</th>
                  <th scope="col">ファイル名</th>
                  <th scope="col">TP数</th>
                  <th scope="col">FP数</th>
                  <th scope="col">FN数</th>
                  <th scope="col">元画像（GT重畳）</th>
                  <th scope="col">検知枠重畳画像</th>
                  <th scope="col">拡大表示</th>
                </tr>
              </thead>
              <tbody>
              {% for prediction_ in prediction %}
                <tr>
                  <td>{{ prediction_.data_id }}</td>
                  <td>{{ prediction_.filename }}</td>
                  <td>{{ prediction_.tp }}</td>
                  <td>{{ prediction_.fp }}</td>
                  <td>{{ prediction_.fn }}</td>
                  <td>{% if prediction_.gt_overlay_url %}<img src="{{ prediction_.gt_overlay_url }}" alt="gt overlay" class="img-thumbnail" style="max-width: 160px; max-height: 160px;" loading="lazy">{% elif prediction_.image_url %}<img src="{{ prediction_.image_url }}" alt="image" class="img-thumbnail" style="max-width: 160px; max-height: 160px;" loading="lazy">{% else %}---{% endif %}</td>
                  <td>{% if prediction_.overlay_url %}<img src="{{ prediction_.overlay_url }}" alt="overlay" class="img-thumbnail" style="max-width: 160px; max-height: 160px;" loading="lazy">{% else %}---{% endif %}</td>
                  <td>
                    <button
                      type="button"
                      class="btn btn-sm btn-primary js-zoom"
                      data-gt="{{ prediction_.gt_overlay_url|default:'' }}"
                      data-pred="{{ prediction_.overlay_url|default:'' }}"
                      data-filename="{{ prediction_.filename|default:'' }}"
                      {% if not prediction_.gt_overlay_url and not prediction_.overlay_url %}disabled{% endif %}
                    >
                      表示
                    </button>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table></p>

            <div class="modal fade" id="overlayZoomModal" tabindex="-1" aria-labelledby="overlayZoomModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="overlayZoomModalLabel">拡大表示</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row g-3">
                      <div class="col-12 col-lg-6">
                        <div class="fw-bold mb-2">GT重畳</div>
                        <img id="zoomGtImg" alt="GT overlay" style="max-width: 100%; max-height: 80vh; width: auto; height: auto; object-fit: contain;">
                      </div>
                      <div class="col-12 col-lg-6">
                        <div class="fw-bold mb-2">検知結果重畳</div>
                        <img id="zoomPredImg" alt="Prediction overlay" style="max-width: 100%; max-height: 80vh; width: auto; height: auto; object-fit: contain;">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <script>
            (function() {
              // Delay until page load so that bootstrap.bundle is definitely available.
              window.addEventListener('load', function() {
                if (!window.bootstrap) { return; }

                const buttons = document.querySelectorAll('.js-zoom');
                const modalEl = document.getElementById('overlayZoomModal');
                if (!modalEl || !buttons.length) { return; }

                const modal = new bootstrap.Modal(modalEl);
                const gtImg = document.getElementById('zoomGtImg');
                const predImg = document.getElementById('zoomPredImg');
                const title = document.getElementById('overlayZoomModalLabel');

                buttons.forEach((btn) => {
                  btn.addEventListener('click', () => {
                    const gt = btn.getAttribute('data-gt') || '';
                    const pred = btn.getAttribute('data-pred') || '';
                    const filename = btn.getAttribute('data-filename') || '';

                    if (title) {
                      title.textContent = filename ? ('拡大表示: ' + filename) : '拡大表示';
                    }

                    if (gtImg) {
                      gtImg.src = gt;
                      gtImg.style.display = gt ? '' : 'none';
                    }
                    if (predImg) {
                      predImg.src = pred;
                      predImg.style.display = pred ? '' : 'none';
                    }

                    modal.show();
                  });
                });
              });
            })();
            </script>
          {% else %}
            {% if dataloader_obj.dataset_type|stringformat:'s' == 'img_clf' or dataloader_obj.dataset_type|stringformat:'s' == 'table_clf' %}
              <div class="container">
                <div class="row">
                  <div class="col-1">
                    <h1 class="h5">Filter: </h1>
                  </div>
                  <div class="col-1">
                    <form method="post">
                    {% csrf_token %}
                      <div class="btn-group">
                        <!-- select filter -->
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                          {{ prediction_filter_selected }}
                        </button>
                        <ul class="dropdown-menu">
                          <li><button class="dropdown-item" type="submit" name="prediction_filter" value="All">All</button></li>
                          <li><button class="dropdown-item" type="submit" name="prediction_filter" value="Correct">Correct</button></li>
                          <li><button class="dropdown-item" type="submit" name="prediction_filter" value="Wrong">Wrong</button></li>
                        </ul>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            {% endif %}

            <p><table class="table table-bordered border-primary table-hover ms-4">
              <thead class="table-dark">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Thumbnail</th>
                  <th scope="col">Prediction</th>
                  <th scope="col">Target</th>
                </tr>
              </thead>
              <tbody>
              {% if dataloader_obj.dataset_type|stringformat:'s' == 'img_clf' or dataloader_obj.dataset_type|stringformat:'s' == 'table_clf' %}
                {% for prediction_ in prediction %}
                  {% if prediction_filter_selected|stringformat:'s' == 'All' %}
                    <tr>
                      <td>{{ prediction_.id }}</td>
                      <td>{% if prediction_.thumbnail_url %}<img src="{{ prediction_.thumbnail_url }}" alt="thumbnail" class="img-thumbnail" style="max-width: 120px; max-height: 120px;" loading="lazy">{% else %}---{% endif %}</td>
                      <td>{{ prediction_.prediction }}{% if prediction_.prediction_name %} ({{ prediction_.prediction_name }}){% endif %}</td>
                      <td>{{ prediction_.target }}{% if prediction_.target_name %} ({{ prediction_.target_name }}){% endif %}</td>
                    </tr>
                  {% elif prediction_filter_selected|stringformat:'s' == 'Correct' %}
                    {% if prediction_.prediction == prediction_.target %}
                      <tr>
                        <td>{{ prediction_.id }}</td>
                        <td>{% if prediction_.thumbnail_url %}<img src="{{ prediction_.thumbnail_url }}" alt="thumbnail" class="img-thumbnail" style="max-width: 120px; max-height: 120px;" loading="lazy">{% else %}---{% endif %}</td>
                        <td>{{ prediction_.prediction }}{% if prediction_.prediction_name %} ({{ prediction_.prediction_name }}){% endif %}</td>
                        <td>{{ prediction_.target }}{% if prediction_.target_name %} ({{ prediction_.target_name }}){% endif %}</td>
                      </tr>
                    {% endif %}
                  {% elif prediction_filter_selected|stringformat:'s' == 'Wrong' %}
                    {% if prediction_.prediction != prediction_.target %}
                      <tr>
                        <td>{{ prediction_.id }}</td>
                        <td>{% if prediction_.thumbnail_url %}<img src="{{ prediction_.thumbnail_url }}" alt="thumbnail" class="img-thumbnail" style="max-width: 120px; max-height: 120px;" loading="lazy">{% else %}---{% endif %}</td>
                        <td>{{ prediction_.prediction }}{% if prediction_.prediction_name %} ({{ prediction_.prediction_name }}){% endif %}</td>
                        <td>{{ prediction_.target }}{% if prediction_.target_name %} ({{ prediction_.target_name }}){% endif %}</td>
                      </tr>
                    {% endif %}
                  {% else %}
                    <tr>
                      <td>---</td>
                      <td>---</td>
                      <td>---</td>
                      <td>---</td>
                    </tr>
                  {% endif %}
                {% endfor %}
              {% else %}
                {% for prediction_ in prediction %}
                  <tr>
                    <td>{{ prediction_.id }}</td>
                    <td>{% if prediction_.thumbnail_url %}<img src="{{ prediction_.thumbnail_url }}" alt="thumbnail" class="img-thumbnail" style="max-width: 120px; max-height: 120px;" loading="lazy">{% else %}---{% endif %}</td>
                    <td>{{ prediction_.prediction }}{% if prediction_.prediction_name %} ({{ prediction_.prediction_name }}){% endif %}</td>
                    <td>{{ prediction_.target }}{% if prediction_.target_name %} ({{ prediction_.target_name }}){% endif %}</td>
                  </tr>
                {% endfor %}
              {% endif %}
              </tbody>
            </table></p>
          {% endif %}
        {% else %}
          <p>No Result</p>
        {% endif %}
      {% else %}
        <p>No Projects</p>
      {% endif %}

    </div>
  </div>
</div>
<script>
(function() {
  const progressCard = document.querySelector('#inference-progress');
  const progressBody = document.querySelector('#inference-progress-body');
  const runForm = document.querySelector('#inference-run-form');
  const runButton = document.querySelector('#inference_run');
  if (!progressCard || !progressBody) { return; }

  const badgeHtml = (status) => {
    const tone = {
      'PENDING': 'secondary',
      'RUNNING': 'info',
      'DONE': 'success',
      'ERROR': 'danger',
      'CANCELED': 'warning',
    }[status] || 'secondary';
    return '<span class="badge bg-' + tone + '" aria-label="' + status + '">' + status + '</span>';
  };

  const renderJob = (job) => {
    if (!job) {
      progressBody.innerHTML = '<p class="text-muted">No inference job running.</p>';
      return;
    }

    const steps = (job.steps || []).slice().sort((a, b) => a.order - b.order);
    if (!steps.length) {
      progressBody.innerHTML = '<p class="text-muted">No steps.</p>';
      return;
    }

    const list = document.createElement('ul');
    list.className = 'list-group list-group-flush';
    steps.forEach((step) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex align-items-center gap-2';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.disabled = true;
      checkbox.className = 'form-check-input';
      checkbox.checked = step.status === 'DONE';
      li.appendChild(checkbox);

      const label = document.createElement('span');
      label.className = 'flex-grow-1';
      label.textContent = step.label;
      li.appendChild(label);

      if (step.status === 'RUNNING') {
        const spinner = document.createElement('div');
        spinner.className = 'spinner-border spinner-border-sm text-primary';
        spinner.setAttribute('role', 'status');
        spinner.innerHTML = '<span class="visually-hidden">Loading...</span>';
        li.appendChild(spinner);
      }

      const state = document.createElement('span');
      state.innerHTML = badgeHtml(step.status);
      li.appendChild(state);

      list.appendChild(li);

      if (step.detail) {
        const detailLi = document.createElement('li');
        detailLi.className = 'list-group-item small text-muted';
        detailLi.textContent = step.detail;
        list.appendChild(detailLi);
      }
    });

    progressBody.innerHTML = '';
    progressBody.appendChild(list);
  };

  let timerId = null;
  const stopPolling = () => {
    if (timerId !== null) {
      clearInterval(timerId);
      timerId = null;
    }
  };

  const fetchJob = async (jobId) => {
    const res = await fetch('/api/jobs/' + jobId + '/');
    if (!res.ok) {
      throw new Error('Failed to fetch job ' + jobId);
    }
    return await res.json();
  };

  const poll = (jobId) => {
    stopPolling();
    timerId = setInterval(async () => {
      try {
        const job = await fetchJob(jobId);
        renderJob(job);
        const done = ['DONE', 'ERROR', 'CANCELED'].includes(job.status);
        if (done) {
          stopPolling();
          if (job.status === 'DONE') {
            setTimeout(() => window.location.reload(), 600);
          }
        }
      } catch (e) {
        stopPolling();
        progressBody.innerHTML = '<p class="text-danger">Failed to load job.</p>';
        console.error(e);
      }
    }, 1000);
  };

  const startJob = (jobId) => {
    if (!jobId) { return; }
    progressCard.dataset.jobId = jobId;
    progressBody.innerHTML = '<p class="text-muted">Loading job ' + jobId + '...</p>';
    poll(jobId);
    if (runButton) {
      runButton.disabled = true;
    }
  };

  const initialJobId = (progressCard.dataset.jobId || '').trim();
  if (initialJobId && initialJobId !== 'None' && initialJobId !== 'null' && initialJobId !== 'undefined') {
    startJob(initialJobId);
  }

  if (runForm) {
    runForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (runButton) {
        runButton.disabled = true;
      }
      const formData = new FormData(runForm);
      // FormData(form) does not reliably include the clicked submit button.
      if (runButton && runButton.name) {
        formData.set(runButton.name, runButton.value || 'inference_run');
      }
      try {
        const res = await fetch(runForm.action || window.location.pathname, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
          },
          body: formData,
        });
        if (!res.ok) {
          const contentType = res.headers.get('content-type') || '';
          const data = contentType.includes('application/json')
            ? await res.json().catch(() => ({}))
            : {};
          const msg = data.error || 'Failed to start inference job.';
          progressBody.innerHTML = '<p class="text-danger">' + msg + '</p>';
          if (runButton) { runButton.disabled = false; }
          return;
        }
        const contentType = res.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          throw new Error('Non-JSON response from server');
        }
        const data = await res.json();
        startJob(data.job_id);
      } catch (err) {
        progressBody.innerHTML = '<p class="text-danger">Failed to start inference job.</p>';
        if (runButton) { runButton.disabled = false; }
        console.error(err);
      }
    });
  }
})();
</script>
{% endblock %}

